<html>

<body>
    <p>
        Select File :
        <input type="file" id="logFiles" name="files[]" />
        <output id="logFileList"></output>
    </p>
    <p>
        Search :
        <input type="text" id="searchString">
        <button onclick="addSearchString()"> Add </button>
        <div id="searchStringsCheckBoxTable"></div>
    </p>
    <p>
        <button id="processLogFileBtn"> Process </button>
    </p>
</body>

<script>
    // Global Variables    
    var logViewData = {
        searchStringsData:[],
        logfile:NaN,
    }

// Register Events
    document.getElementById('logFiles').addEventListener('change', handleFileSelect, false);
    document.getElementById('processLogFileBtn').addEventListener('click', handleOnClickProcessLogFile, false);

// Functions

    function handleFileSelect(evt) {
        var files = evt.target.files; // FileList object

        // files is a FileList of File objects. List some properties.
        var output = [];
        for (var i = 0, f; f = files[i]; i++) {
            output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
                      f.size, ' bytes, last modified: ',
                      f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
                      '</li>');
        }
        document.getElementById('logFileList').innerHTML = '<ul>' + output.join('') + '</ul>';
        logViewData.logfile = files[0]
    }    
    
    function addSearchString() {
        searchString = document.getElementById("searchString").value
        for (i in logViewData.searchStringsData) {
            if (logViewData.searchStringsData[i].searchString == searchString) return
        }
        if (searchString.length != 0) {
            logViewData.searchStringsData.push({searchString:searchString, used:'checked', color:getNewColor()})
            updateSearchStringsCheckBox()
        }
    }
    
    function updateSearchStringCheckBox(checked, index) {
        console.log("updateSearchStringCheckBox = " + checked + index)
        if (checked) {
            logViewData.searchStringsData[index].used = "checked"
        }
        else {
            logViewData.searchStringsData[index].used = ""
        }
    }
    
    function getOneSearchStringCheckBox(index, searchStringData) {
        var oneSearchStringOutput = "<input type='checkbox' id = 'searchStringCheckBox_" + index + "' " + searchStringData.used + 
        " onclick = 'updateSearchStringCheckBox(this.checked, " + index + ")' > " + searchStringData.searchString
        console.log(oneSearchStringOutput)
        return oneSearchStringOutput
    }
    function updateSearchStringsCheckBox() {
        var searchStringsOutput = []
        
        searchStringsOutput.push("<table>")
        for (i in logViewData.searchStringsData) {
            searchStringsOutput.push("<tr style='color:" + logViewData.searchStringsData[i].color + "'>")
            searchStringsOutput.push("<td>" + getOneSearchStringCheckBox(i, logViewData.searchStringsData[i]) + "</td>")
            searchStringsOutput.push("<td>" + logViewData.searchStringsData[i].color + "</td>")
            searchStringsOutput.push("</tr>")
        }
        searchStringsOutput.push("</table>")
        document.getElementById("searchStringsCheckBoxTable").innerHTML = searchStringsOutput.join("")
        console.log(searchStringsOutput.join(""))
    }
    
    var colorPickerData = {
        currentIndex:0,
        colorTable: [
        "#ff0000", "#ff4000", "#ff8000", "#ffbf00", "#ffff00", 
        "#bfff00", "#80ff00", "#40ff00", "#00ff00", "#00ff40", 
        "#00ff80", "#00ffbf", "#00ffff", "#00bfff", "#007fff", 
        "#0040ff", "#0000ff", "#4000ff", "#7f00ff", "#bf00ff", 
        "#ff00ff", "#ff00bf", "#ff0080"]
    }
    
    function getNewColor() {
        var c = colorPickerData.colorTable[colorPickerData.currentIndex]
        colorPickerData.currentIndex += 1
        colorPickerData.currentIndex =  colorPickerData.currentIndex % colorPickerData.colorTable.length
        return c
    }
    
    function handleOnClickProcessLogFile(evt) {
        var logLines = []
        var reader = new FileReader()
        reader.onload = function(e) {
            var contents = e.target.result;
            logLines = parseLogFile(contents)
            logData = processLogData(logLines)
            ouputLogData(logData)
        }
        
        reader.readAsText(logViewData.logfile)
    }
    
    function parseLogFile(contents) {
        logLines = []
        startTimeMs = -1
        var lines = contents.toString().split("\n");
        for (i in lines) {
            var t = lines[i].match(/\d+:\d+:\d+:\d+/)
            if (t) {
                tstr = t[0].split(":")
                timeMs = parseInt(tstr[3]) + parseInt(tstr[2]) * 1000 + parseInt(tstr[1]) * 1000 * 60 + parseInt(tstr[0]) * 1000 * 60 * 60
                if (startTimeMs == -1) {
                    startTimeMs = timeMs
                }
                var oneLogLine = {tMs:(timeMs - startTimeMs), line:lines[i]}
                logLines.push(oneLogLine)
            }
        }
        return logLines
    }
    function processLogData(logLines) {
        console.log(logLines)
    }
    function ouputLogData(logData) {
        
    }
</script>

</html>